#!/usr/bin/env python
import argparse
import sys
import subprocess
from ConfigParser import SafeConfigParser

def status():
    rc = subprocess.call("cl-vrf mgmt status", shell=True)
    sys.exit(rc)

def enable():
    sys.stdout.write("""
Management VRF is configured by adding the following stanza to
/etc/network/interfaces

    auto mgmt
    iface mgmt
        address 127.0.0.1/8
        vrf-table auto
        vrf-default-route no

And then adding 'vrf mgmt' to the interface stanza. For example,
    auto eth0
    iface eth0 inet dhcp
        vrf mgmt

Remember to add 'table mgmt' to all static routes. Use 'ifreload -a'
to have the new configuration take effect.

NOTE: When enabling management VRF any active sessions over the
      management interface need to be restarted.

""")
    sys.exit(1)

def disable():
    sys.stdout.write("""
Management VRF is disabled by removing the 'iface mgmt' stanza to
/etc/network/interfaces, and then removing 'vrf mgmt' from the
interface stanza for eth0.

Use 'ifreload -a' to have the new configuration take effect.

NOTE: When disabling management VRF any active sessions over the
      management interface need to be restarted.

""")
    sys.exit(1)

if __name__ == '__main__':

    parser  = argparse.ArgumentParser(description='Configure management VRF')
    group = parser.add_mutually_exclusive_group()
    group.add_argument('-e', '--enable', help='Enable management VRF', action='store_true')
    group.add_argument('-d', '--disable', help='Disable management VRF', action='store_true')
    group.add_argument('-s', '--status', help='Display if management VRF is enabled', action='store_true')
    parser.add_argument('interface', nargs ='?', help='Set management interface', action = 'store', default='eth0')
    args = parser.parse_args()

    if args.enable:
        enable()
    elif args.disable:
        disable()
    elif args.status:
        status()
    else:
        sys.stdout.write('ERROR: %s' % parser.format_help())
        sys.exit(1)
