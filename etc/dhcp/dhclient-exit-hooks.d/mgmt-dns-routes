[ -r /var/lib/cl-mgmtvrf/mgmtvrf.conf ] && . /var/lib/cl-mgmtvrf/mgmtvrf.conf

# Cleanup DNS state if we've been terminated
if [ ! -e /var/run/cl-mgmtvrf ]; then
    ip rule | grep -q '^99:'
    if [ $? -eq 0 ] && [ -n "$old_domain_name_servers" ]; then
       # Delete rules associated with old DNS server
       for dns in $old_domain_name_servers; do
       	   ip rule del to $dns lookup 252 prio 99 2>&1 >/dev/null
       done
    fi
    exit 0
fi

if [ -n "$MGMTVRF_IF" ] && [ "$MGMTVRF_IF" = "${interface}" ] && [ -n "${new_routers}" ]; then
    sudo ip route del default via ${new_routers} dev ${interface}

    # Since we're doing route table updates of mgmt table, cleanup old stuff
    if [ -n "${old_network_number}" ] && [ -n "${old_subnet_mask}" ]; then
        sudo ip route del ${old_network_number}/${old_subnet_mask} dev ${interface} table mgmt
    fi

    if [ -n "${old_routers}" ]; then
        sudo ip route del default via ${old_routers} dev ${interface} table mgmt
    fi
    sudo ip route add default via ${new_routers} dev ${interface} table mgmt
    sudo ip route add ${new_network_number}/${new_subnet_mask} dev ${interface} src ${new_ip_address} table mgmt

    # Add rules to handle DNS server
    if [ -n "$old_domain_name_servers" ]; then
       # Delete rules associated with old DNS server
       for dns in $old_domain_name_servers; do
       	   ip rule del to $dns lookup mgmt prio 99 2>&1 >/dev/null
       done
    fi

    if [ -n "$new_domain_name_servers" ]; then
	for dns in $new_domain_name_servers; do
	    ip rule add to $dns lookup mgmt prio 99 2>&1 >/dev/null
	done
    fi
fi
